# Display Order Number Architecture

## 1. Purpose

To introduce a human-readable, day-specific, and area-specific order number that is more user-friendly for customers and staff than the internal GUID-based `Order.Id`. This new "Display Order Number" will be used on printed receipts, comandas, Kitchen Display Systems (KDS), public pickup displays, and other operational interfaces.

The internal `Order.Id` will transition to using standard GUIDs for new orders, ensuring database uniqueness without requiring migration of existing `Id` values.

## 2. Components

### 2.1. Backend (SagraFacile.NET)

*   **`SagraFacile.NET.API/Models/Order.cs`**
    *   **`public string Id { get; set; }`**:
        *   For **new** orders, this will be populated with `Guid.NewGuid().ToString()`.
        *   Existing `Id` values (previously generated by `OrderIdGenerator`) will remain unchanged.
    *   **`public string DisplayOrderNumber { get; set; }`**:
        *   A new string property to store the generated human-readable order number (e.g., "CUC-001", "BAR-123").
        *   This field will be indexed for potential lookups, though primary lookups will still use `Id`.

*   **`SagraFacile.NET.API/Models/Area.cs`**
    *   **`public string Slug { get; set; }`**:
        *   The existing `Slug` field will be used to derive the prefix for the `DisplayOrderNumber`. No new field for a prefix will be added.

*   **New Entity: `SagraFacile.NET.API/Models/AreaDayOrderSequence.cs`**
    *   `public int Id { get; set; }` (Primary Key)
    *   `public int AreaId { get; set; }` (Foreign Key to `Area`)
    *   `public virtual Area Area { get; set; }`
    *   `public int DayId { get; set; }` (Foreign Key to `Day`)
    *   `public virtual Day Day { get; set; }`
    *   `public int LastSequenceNumber { get; set; }` (Stores the last used sequence number for the combination of Area and Day)
    *   **Database Constraints:** A composite unique index will be applied on `(AreaId, DayId)` to ensure only one sequence record per area per day.

### 2.2. DTOs (SagraFacile.NET.API/DTOs/)

The `DisplayOrderNumber` property will be added to relevant DTOs:
*   `OrderDto.cs`
*   `KdsOrderDto.cs`
*   `OrderStatusBroadcastDto.cs`
*   Any other DTOs that expose order identification to the frontend or other services.

## 3. Generation Logic for `DisplayOrderNumber`

The `DisplayOrderNumber` is generated within the `OrderService` during two key operations:
1.  `CreateOrderAsync` (for new orders placed directly at the cashier).
2.  `ConfirmPreOrderPaymentAsync` (when a pre-order is finalized and becomes an active order for the current operational day).

**Generation Steps (within a database transaction):**

1.  **Retrieve `Area.Slug`**: Get the slug of the `Area` associated with the order.
2.  **Derive Prefix from `Area.Slug`**:
    a.  Convert the `Area.Slug` to **uppercase**.
    b.  Remove any non-alphanumeric characters (e.g., hyphens, underscores).
    c.  Truncate the resulting string to a maximum length of **3 characters**.
    d.  If the cleaned slug is shorter than 3 characters, use the entire cleaned slug.
    e.  If the cleaned slug is empty after processing (e.g., slug was `"--"`), a fallback prefix like "ORD" will be used, or an error might be logged/thrown if slugs are expected to be valid.
    *   *Examples:*
        *   `cucina-principale` -> `CUC`
        *   `bar-1` -> `BAR` (assuming '1' is removed by non-alphanumeric cleaning, if not, `BAR1` -> `BAR`)
        *   `c1` -> `C1`
        *   `pizzeria` -> `PIZ`
3.  **Retrieve/Create `AreaDayOrderSequence`**:
    a.  Fetch the `AreaDayOrderSequence` record for the order's `AreaId` and current `DayId`.
    b.  If no record exists, create a new one with `LastSequenceNumber = 0`.
4.  **Increment Sequence**: Atomically increment the `LastSequenceNumber` for the fetched/created `AreaDayOrderSequence` record.
5.  **Save Sequence**: Save the updated `AreaDayOrderSequence` record.
6.  **Construct `DisplayOrderNumber`**:
    *   Format: `"{DerivedPrefix}-{LastSequenceNumber:D3}"`.
    *   The `:D3` format specifier ensures the number is zero-padded to at least three digits (e.g., `001`, `042`, `123`).
    *   If `LastSequenceNumber` exceeds 999 (e.g., 1000), it will be formatted as such (e.g., `CUC-1000`).
7.  **Assign to Order**: Set `order.DisplayOrderNumber` to the constructed string.

## 4. Uniqueness and Display Context

*   **Uniqueness**: The `DisplayOrderNumber` is unique per `(DayId, AreaId)`. This is enforced by the `AreaDayOrderSequence` logic.
*   **Prefix Collisions**: If different `Area.Slug` values result in the same derived prefix (e.g., "cucina-uno" -> `CUC` and "cucina-due" -> `CUC`), they will share the same prefix letters. This is acceptable because:
    *   The full operational context, including the **Date**, the full **Area Name (or Slug)**, and the `DisplayOrderNumber`, will always be presented together on prints and displays. This ensures clear differentiation.
    *   Example:
        *   `Date: 2025-06-03, Area: Cucina Principale, Order: CUC-001`
        *   `Date: 2025-06-03, Area: Cucina Esterna, Order: CUC-001`
*   **Admin Guidance**: Administrators should be aware that if they desire visually distinct prefixes without relying solely on the full Area name, they should choose `Area.Slug` values that will result in unique derived prefixes after the transformation logic (uppercase, alphanumeric, truncate to 3 chars).

## 5. Impact on System

*   **Database**:
    *   `Orders` table: New `DisplayOrderNumber` column.
    *   `Areas` table: No changes.
    *   New `AreaDayOrderSequences` table.
    *   EF Core migration required.
*   **Backend Services**:
    *   `OrderService`: Major changes to incorporate `DisplayOrderNumber` generation and `Order.Id` GUID generation.
    *   `PrinterService`: Needs to be updated to use `DisplayOrderNumber`, Date, and Area Name/Slug in printouts.
*   **Frontend (sagrafacile-webapp)**:
    *   **Types**: Update DTOs (`OrderDto`, `KdsOrderDto`, etc.) to include `displayOrderNumber`.
    *   **UI Components**: All components displaying order identifiers for operational purposes (receipts, KDS, public displays, cashier views, admin order lists) need to be updated to show `displayOrderNumber` along with Date and Area context.
    *   **Admin UI**: No new field for prefix configuration in Area settings, as it's derived from the slug. A help text or note could be added to the Area slug field explaining its influence on the order number prefix.
*   **Existing Data**:
    *   Existing `Order.Id` values will not be changed.
    *   Existing orders will **not** have a `DisplayOrderNumber` retrospectively generated unless a specific backfill process is implemented (currently not planned as part of this initial feature). New orders created after this feature is deployed will have the `DisplayOrderNumber`.

## 6. Future Considerations

*   **Retrospective Generation**: A one-time script could be developed to generate `DisplayOrderNumber` values for existing historical orders if deemed necessary, but this would require careful consideration of sequence starting points for past days.
*   **Prefix Configuration UI**: If deriving from the slug becomes problematic or more control is desired, a dedicated `OrderNumberPrefix` field could be added to the `Area` model in the future, along with UI for admins to set it. For now, the slug-derivation approach is preferred for simplicity.
